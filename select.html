<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Your Numbers</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; margin: 0; }
    .number-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px; max-width: 600px; margin: auto; }
    .number-cell { aspect-ratio: 1 / 1; background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px;
                   display: flex; align-items: center; justify-content: center; font-size: 1.2em;
                   cursor: pointer; user-select: none; transition: background-color 0.3s; }
    .number-cell.selected { background-color: #4caf50; color: white; border-color: #388e3c; }
    #summary { margin-top: 1.5em; text-align: center; font-size: 1em; }
    #confirmBtn, #clearBtn { margin-top: 1em; padding: 0.8em 1.6em; font-size: 1em; cursor: pointer; margin-right: 1em; }
    #priorityList { text-align: left; margin-top: 1em; font-family: monospace; white-space: pre-line; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2 id="welcome"></h2>
  <div class="number-grid" id="numbers"></div>

  <div id="summary">
    <p><strong>Your Selections:</strong></p>
    <div id="priorityList">None</div>
    <button id="confirmBtn" disabled>Confirm Selection</button>
    <button id="clearBtn">Clear All</button>
  </div>

  <script>
    const SUPABASE_URL = "https://cfuwtozobaypksesmxsi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmdXd0b3pvYmF5cGtzZXNteHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNDc1NjksImV4cCI6MjA3NjcyMzU2OX0.SbpESIaS7JZJmWHQ6ApifGDPYZZf3ekdQ0T_mgHCPSc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const pid = sessionStorage.getItem("pid");
    const pw  = sessionStorage.getItem("pw");
    const pname = sessionStorage.getItem("pname") || "Participant";

    if (!pid || !pw) {
      alert("Please log in first.");
      window.location.replace("participant.html");
    }

    document.getElementById("welcome").textContent = `Welcome ${pid} - ${pname}`;

    // ✅ Verify credentials before allowing access
    async function verifySession() {
      const { data, error } = await supabase.rpc("verify_participant_login", {
        p_participant_id: pid,
        p_password: pw
      });
      if (error || !data || !data.length) {
        alert("Session expired or invalid. Please log in again.");
        sessionStorage.clear();
        window.location.replace("participant.html");
      }
    }
    verifySession();

    const numbersDiv = document.getElementById("numbers");
    const priorityListDiv = document.getElementById("priorityList");
    const confirmBtn = document.getElementById("confirmBtn");
    const clearBtn = document.getElementById("clearBtn");

    const selectedList = [];
    let existingSelections = [];

    // ✅ Load opposite-gender IDs dynamically
    async function loadOppositeIDs() {
      try {
        const { data, error } = await supabase.rpc("get_opposite_ids", { p_participant_id: pid });
        if (error) throw error;
        if (!data || data.length === 0) {
          numbersDiv.innerHTML = "<p>No participants available to select from.</p>";
          return;
        }

        // Build grid with returned IDs
        numbersDiv.innerHTML = "";
        data.forEach(row => {
          const cell = document.createElement("div");
          cell.classList.add("number-cell");
          cell.textContent = row.participant_id;
          cell.dataset.number = row.participant_id;
          cell.addEventListener("click", () => toggleSelection(row.participant_id, cell));
          numbersDiv.appendChild(cell);
        });
      } catch (err) {
        console.error("Error loading IDs:", err);
      }
    }

    function toggleSelection(id, cell) {
      const index = selectedList.indexOf(id);
      if (index > -1) {
        selectedList.splice(index, 1);
        cell.classList.remove("selected");
      } else {
        selectedList.push(id);
        cell.classList.add("selected");
      }
      updateSelectionDisplay();
    }

    function updateSelectionDisplay() {
      if (selectedList.length === 0) {
        priorityListDiv.textContent = "None";
        confirmBtn.disabled = false;
        return;
      }
      // ✅ New simplified summary
      priorityListDiv.textContent = `These are your selections: ${selectedList.join(", ")}`;
      confirmBtn.disabled = false;
    }

    async function loadParticipantData() {
      try {
        const { data, error } = await supabase
          .from("participants")
          .select("selections")
          .eq("participant_id", pid)
          .maybeSingle();
        if (error) throw error;
        if (data && data.selections) {
          existingSelections = data.selections;
          existingSelections.forEach(sel => {
            const cell = [...document.querySelectorAll(".number-cell")]
              .find(c => c.dataset.number === sel);
            if (cell) cell.classList.add("selected");
          });
          selectedList.push(...existingSelections);
          updateSelectionDisplay();
        }
      } catch (err) {
        console.error("Load error:", err);
      }
    }

    async function saveSelectionIfChanged() {
      const newSelections = [...selectedList];
      try {
        const { data: existing } = await supabase
          .from("participants")
          .select("id")
          .eq("participant_id", pid)
          .maybeSingle();

        if (existing) {
          await supabase
            .from("participants")
            .update({ selections: newSelections })
            .eq("participant_id", pid);
        } else {
          await supabase
            .from("participants")
            .insert([{ participant_id: pid, name: pname, selections: newSelections }]);
        }

        alert(`✅ Thank you, ${pname}! Your selections are saved.`);
        sessionStorage.clear();
        window.location.replace("scanqr.html");
      } catch (err) {
        console.error("Save error:", err);
        alert("⚠️ Failed to save data.");
      }
    }

    confirmBtn.addEventListener("click", saveSelectionIfChanged);
    clearBtn.addEventListener("click", () => {
      selectedList.length = 0;
      document.querySelectorAll(".number-cell.selected").forEach(c => c.classList.remove("selected"));
      updateSelectionDisplay();
    });

    // Initialize page
    (async () => {
      await loadOppositeIDs();
      await loadParticipantData();
    })();
  </script>
</body>
</html>
