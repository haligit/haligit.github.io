<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Your Numbers</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; margin: 0; }
    .number-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px; max-width: 600px; margin: auto; }
    .number-cell { aspect-ratio: 1 / 1; background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px;
                   display: flex; align-items: center; justify-content: center; font-size: 1.2em;
                   cursor: pointer; user-select: none; transition: background-color 0.3s; }
    .number-cell.selected { background-color: #4caf50; color: white; border-color: #388e3c; }
    #summary { margin-top: 1.5em; text-align: center; font-size: 1em; }
    #confirmBtn, #clearBtn { margin-top: 1em; padding: 0.8em 1.6em; font-size: 1em; cursor: pointer; margin-right: 1em; }
    #priorityList { text-align: left; margin-top: 1em; font-family: monospace; white-space: pre-line; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2 id="welcome"></h2>
  <div class="number-grid" id="numbers"></div>

  <div id="summary">
    <p><strong>Your Selections:</strong></p>
    <div id="priorityList">None</div>

    <!-- Matches -->
    <div id="matchesBlock" style="margin-top:1em; text-align:left; display:none;">
      <p><strong>Matches:</strong></p>
      <div id="matchesList"></div>
    </div>

    <!-- People interested in you -->
    <div id="interestBlock" style="margin-top:1em; text-align:left; display:none;">
      <p><strong>People interested in you:</strong></p>
      <div id="interestList"></div>
    </div>

    <button id="confirmBtn" disabled>Confirm Selection</button>
    <button id="clearBtn">Clear All</button>
  </div>

<script>
const SUPABASE_URL = "https://cfuwtozobaypksesmxsi.supabase.co";
const SUPABASE_ANON_KEY = "YOUR KEY HERE";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const pid   = sessionStorage.getItem("pid");
const pw    = sessionStorage.getItem("pw");
const pname = sessionStorage.getItem("pname") || "Participant";

if (!pid || !pw) {
  alert("Please log in first.");
  window.location.replace("participant.html");
}

document.getElementById("welcome").textContent = `Welcome ${pid} - ${pname}`;

// Verify session
async function verifySession() {
  const { data, error } = await supabase.rpc("verify_participant_login", {
    p_participant_id: pid,
    p_password: pw
  });
  if (error || !data || !data.length) {
    alert("Session expired. Log in again.");
    sessionStorage.clear();
    window.location.replace("participant.html");
  }
}
verifySession();

const numbersDiv      = document.getElementById("numbers");
const priorityListDiv = document.getElementById("priorityList");
const confirmBtn      = document.getElementById("confirmBtn");
const clearBtn        = document.getElementById("clearBtn");

const matchesBlock    = document.getElementById("matchesBlock");
const matchesList     = document.getElementById("matchesList");
const interestBlock   = document.getElementById("interestBlock");
const interestList    = document.getElementById("interestList");

let selectedList = [];
let existingSelections = [];

// Load possible opposite IDs
async function loadNumbers() {
  const { data, error } = await supabase.rpc("get_opposite_ids", { p_pid: pid });
  if (error) return console.error(error.message);

  numbersDiv.innerHTML = "";
  selectedList.length = 0;

  (data || []).forEach(row => {
    const fullId = row.id;
    const cell = document.createElement("div");
    cell.classList.add("number-cell");
    cell.dataset.pid = fullId;
    cell.textContent = fullId;
    cell.addEventListener("click", () => toggleSelection(fullId, cell));
    numbersDiv.appendChild(cell);
  });
}

function toggleSelection(id, cell) {
  const idx = selectedList.indexOf(id);
  if (idx >= 0) {
    selectedList.splice(idx, 1);
    cell.classList.remove("selected");
  } else {
    selectedList.push(id);
    cell.classList.add("selected");
  }
  updateSummary();
  refreshLiveMatchState();
}

function updateSummary() {
  if (!selectedList.length) {
    priorityListDiv.textContent = "None";
    confirmBtn.disabled = false;
    return;
  }
  priorityListDiv.textContent = "You selected: " + selectedList.join(", ");
  confirmBtn.disabled = false;
}

// Load saved selections
async function loadExistingSelections() {
  const { data, error } = await supabase
    .from("participants")
    .select("selections")
    .eq("participant_id", pid)
    .maybeSingle();

  if (error) return;

  if (data && data.selections) {
    existingSelections = data.selections;
    existingSelections.forEach(sel => {
      const cell = document.querySelector(`.number-cell[data-pid="${sel}"]`);
      if (cell) {
        cell.classList.add("selected");
        selectedList.push(sel);
      }
    });
    updateSummary();
  }
}

// ðŸ”µ Identify live matches (temporary, not saved yet)
async function refreshLiveMatchState() {
  const { data: others } = await supabase
    .from("participants")
    .select("participant_id, selections");

  if (!others) return;

  const mySel = selectedList;
  const matches = [];
  const interests = [];

  others.forEach(row => {
    if (row.participant_id === pid) return;

    const theirSel = row.selections || [];

    const I_like = mySel.includes(row.participant_id);
    const they_like = theirSel.includes(pid);

    if (I_like && they_like) matches.push(row.participant_id);
    else if (!I_like && they_like) interests.push(row.participant_id);
  });

  // Update live UI
  renderLiveMatchInterest(matches, interests);
}

function renderLiveMatchInterest(matches, interests) {
  // Matches
  matchesList.innerHTML = "";
  if (matches.length) {
    matchesBlock.style.display = "block";
    matches.forEach(id => {
      const div = document.createElement("div");
      div.innerHTML = `
        â€¢ ${id} â€” <span>Number will be revealed when both parties agree.</span><br>
        <label><input type="checkbox" disabled> Share my number (?)</label>
      `;
      matchesList.appendChild(div);
    });
  } else matchesBlock.style.display = "none";

  // Interests
  interestList.innerHTML = "";
  if (interests.length) {
    interestBlock.style.display = "block";
    interests.forEach(id => {
      const div = document.createElement("div");
      div.textContent = id;
      interestList.appendChild(div);
    });
  } else interestBlock.style.display = "none";
}

// SAVE selections
async function saveSelections() {
  const newSelections = [...selectedList];

  // ðŸ”´ RESET NUMBER SHARE for removed matches
  const removed = existingSelections.filter(x => !newSelections.includes(x));
  for (const otherId of removed) {
    const id1 = pid < otherId ? pid : otherId;
    const id2 = pid < otherId ? otherId : pid;
    await supabase.from("number_share").delete().match({ p1_id: id1, p2_id: id2 });
  }

  // Save new selections
  const { data: existing } = await supabase
    .from("participants")
    .select("id")
    .eq("participant_id", pid)
    .maybeSingle();

  if (existing) {
    await supabase.from("participants")
      .update({ selections: newSelections })
      .eq("participant_id", pid);
  } else {
    await supabase.from("participants")
      .insert([{ participant_id: pid, name: pname, selections: newSelections }]);
  }

  alert(`Thank you, ${pname}. Your selections are saved.`);

  await loadMatchesAndInterests();

  setTimeout(() => {
    sessionStorage.clear();
    window.location.replace("scanqr.html");
  }, 800);
}

confirmBtn.addEventListener("click", saveSelections);
clearBtn.addEventListener("click", () => {
  selectedList = [];
  document.querySelectorAll(".number-cell.selected")
    .forEach(c => c.classList.remove("selected"));
  updateSummary();
});

// Load secure match + reveal system
async function loadMatchesAndInterests() {
  const { data, error } = await supabase.rpc("get_matches_and_interests_secure", { p_pid: pid });
  if (error) return;

  const rows = data || [];

  const matches   = rows.filter(r => r.match_id);
  const matchIDs  = matches.map(m => m.match_id);
  const interests = rows
      .filter(r => r.interest_id)
      .filter(r => !matchIDs.includes(r.interest_id));

  // Render matches
  matchesList.innerHTML = "";
  if (matches.length) {
    matchesBlock.style.display = "block";

    matches.forEach(m => {
      const div = document.createElement("div");
      const other = m.match_id;
      const reveal = m.reveal_number;

      if (reveal) {
        div.innerHTML = `
          â€¢ ${other} â€” <strong>ðŸ“ž ${reveal}</strong><br>
          <label><input type="checkbox" data-other="${other}" checked> Share my number (?)</label>
        `;
      } else {
        div.innerHTML = `
          â€¢ ${other}<br>
          <button data-reveal="${other}">Tap to reveal</button><br>
          <label><input type="checkbox" data-other="${other}"> Share my number (?)</label>
        `;
      }

      matchesList.appendChild(div);

      // Checkbox updates DB
      const cb = div.querySelector("input[type='checkbox']");
      cb.addEventListener("change", async () => {
        await supabase.rpc("update_number_share", {
          p_pid: pid,
          p_other: other,
          p_agree: cb.checked
        });
        await loadMatchesAndInterests();
      });

      // Tap-to-reveal
      const btn = div.querySelector("button[data-reveal]");
      if (btn) {
        btn.addEventListener("click", async () => {
          const { data } = await supabase.rpc("get_matches_and_interests_secure", { p_pid: pid });
          const row = data.find(r => r.match_id === other);
          if (row && row.reveal_number) {
            btn.outerHTML = `<strong>ðŸ“ž ${row.reveal_number}</strong>`;
          } else {
            btn.textContent = "Waiting for other participantâ€¦";
            setTimeout(() => btn.textContent = "Tap to reveal", 1500);
          }
        });
      }
    });
  } else matchesBlock.style.display = "none";

  // Render interests
  interestList.innerHTML = "";
  if (interests.length) {
    interestBlock.style.display = "block";
    interests.forEach(i => {
      const div = document.createElement("div");
      div.textContent = i.interest_id;
      interestList.appendChild(div);
    });
  } else interestBlock.style.display = "none";
}

// INIT
(async function init() {
  await loadNumbers();
  await loadExistingSelections();
  setTimeout(async () => {
    await loadMatchesAndInterests();
    await refreshLiveMatchState();
  }, 150);
})();
</script>
</body>
</html>
