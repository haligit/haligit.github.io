<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Your Numbers</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; margin: 0; }
    .number-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px; max-width: 600px; margin: auto; }
    .number-cell { aspect-ratio: 1 / 1; background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px;
                   display: flex; align-items: center; justify-content: center; font-size: 1.2em;
                   cursor: pointer; user-select: none; transition: background-color 0.3s; }
    .number-cell.selected { background-color: #4caf50; color: white; border-color: #388e3c; }
    #summary { margin-top: 1.5em; text-align: center; font-size: 1em; }
    #confirmBtn, #clearBtn { margin-top: 1em; padding: 0.8em 1.6em; font-size: 1em; cursor: pointer; margin-right: 1em; }
    #priorityList { text-align: left; margin-top: 1em; font-family: monospace; white-space: pre-line; }

    /* NEW SECTIONS */
    .section-block { margin-top: 25px; padding: 12px; background: #fafafa; border: 1px solid #ddd; border-radius: 8px; }
    .match-row, .interest-row { padding: 6px 0; border-bottom: 1px solid #e0e0e0; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2 id="welcome"></h2>
  <div class="number-grid" id="numbers"></div>

  <div id="summary">
    <p><strong>Your Selections:</strong></p>
    <div id="priorityList">None</div>
    <button id="confirmBtn" disabled>Confirm Selection</button>
    <button id="clearBtn">Clear All</button>
  </div>

  <!-- ðŸ”µ NEW SECTION A: Matches -->
  <div id="matchSection" class="section-block" style="display:none;">
    <h3>Your Matches</h3>
    <div id="matchesList"></div>
  </div>

  <!-- ðŸ”µ NEW SECTION B: Incoming Interest -->
  <div id="interestSection" class="section-block" style="display:none;">
    <h3>People Interested in You</h3>
    <div id="interestList"></div>
  </div>

  <script>
    const SUPABASE_URL = "https://cfuwtozobaypksesmxsi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmdXd0b3pvYmF5cGtzZXNteHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNDc1NjksImV4cCI6MjA3NjcyMzU2OX0.SbpESIaS7JZJmWHQ6ApifGDPYZZf3ekdQ0T_mgHCPSc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const pid = sessionStorage.getItem("pid");
    const pw  = sessionStorage.getItem("pw");
    const pname = sessionStorage.getItem("pname") || "Participant";

    if (!pid || !pw) {
      alert("Please log in first.");
      window.location.replace("participant.html");
    }

    document.getElementById("welcome").textContent = `Welcome ${pid} - ${pname}`;

    // Secure session re-verification
    async function verifySession() {
      const { data, error } = await supabase.rpc("verify_participant_login", {
        p_participant_id: pid,
        p_password: pw
      });
      if (error || !data || !data.length) {
        alert("Session expired or invalid. Please log in again.");
        sessionStorage.clear();
        window.location.replace("participant.html");
      }
    }
    verifySession();

    // DOM references
    const numbersDiv = document.getElementById("numbers");
    const priorityListDiv = document.getElementById("priorityList");
    const confirmBtn = document.getElementById("confirmBtn");
    const clearBtn = document.getElementById("clearBtn");

    const matchSection = document.getElementById("matchSection");
    const matchesList = document.getElementById("matchesList");

    const interestSection = document.getElementById("interestSection");
    const interestList = document.getElementById("interestList");

    let selectedList = [];
    let existingSelections = [];

    // Create dynamic grid from database
    async function loadNumbers() {
      const prefix = pid.startsWith("M") ? "F" : "M";
      const { data, error } = await supabase.rpc("get_opposite_ids", { p_participant_id: pid });
      if (error) {
        console.error(error);
        return;
      }

      // Create grid
      numbersDiv.innerHTML = "";
      selectedList = [];

      data.forEach(val => {
        const num = val.substring(1);
        const cell = document.createElement("div");
        cell.className = "number-cell";
        cell.textContent = num;
        cell.dataset.pid = val;
        cell.addEventListener("click", () => toggleSelection(val, cell));
        numbersDiv.appendChild(cell);
      });
    }

    function toggleSelection(id, cell) {
      const idx = selectedList.indexOf(id);
      if (idx >= 0) {
        selectedList.splice(idx, 1);
        cell.classList.remove("selected");
      } else {
        selectedList.push(id);
        cell.classList.add("selected");
      }
      updateSummary();
      loadMatchList();
    }

    function updateSummary() {
      if (selectedList.length === 0) {
        priorityListDiv.textContent = "None";
        confirmBtn.disabled = false;
        return;
      }
      priorityListDiv.textContent = `You selected: ${selectedList.join(", ")}`;
      confirmBtn.disabled = false;
    }

    async function loadExistingSelections() {
      const { data, error } = await supabase
        .from("participants")
        .select("selections")
        .eq("participant_id", pid)
        .maybeSingle();

      if (data && data.selections) {
        existingSelections = data.selections;
        existingSelections.forEach(id => {
          const cell = [...document.querySelectorAll(".number-cell")]
            .find(c => c.dataset.pid === id);
          if (cell) {
            cell.classList.add("selected");
            selectedList.push(id);
          }
        });
        updateSummary();
      }
    }

    async function saveSelections() {
      const newSelections = [...selectedList];

      const { data: existing } = await supabase
        .from("participants")
        .select("id")
        .eq("participant_id", pid)
        .maybeSingle();

      if (existing) {
        await supabase
          .from("participants")
          .update({ selections: newSelections })
          .eq("participant_id", pid);
      } else {
        await supabase
          .from("participants")
          .insert([{ participant_id: pid, name: pname, selections: newSelections }]);
      }

      alert("Selections saved successfully!");
      sessionStorage.clear();
      window.location.replace("scanqr.html");
    }

    confirmBtn.addEventListener("click", saveSelections);
    clearBtn.addEventListener("click", () => {
      selectedList = [];
      updateSummary();
      document.querySelectorAll(".number-cell").forEach(c => c.classList.remove("selected"));
      loadMatchList();
    });

    // ðŸ”µ NEW â€” Load matches and interests
    async function loadMatchList() {
      const { data, error } = await supabase.rpc("get_matches_and_interests", {
        p_participant_id: pid
      });

      if (error) {
        console.error(error);
        return;
      }

      const matches = data.matches || [];
      const interests = data.interests || [];

      // Show/hide sections
      matchSection.style.display = matches.length ? "block" : "none";
      interestSection.style.display = interests.length ? "block" : "none";

      // Build matches list
      matchesList.innerHTML = "";
      matches.forEach(m => {
        const row = document.createElement("div");
        row.className = "match-row";
        row.innerHTML = `
          <strong>${m.id}</strong><br>
          ${
            m.telephone
              ? `<span style='color:green;'>Telephone: ${m.telephone}</span>`
              : `<span style='color:#777;'>Telephone will be revealed when both parties agree.</span>`
          }
          <br>
          <label><input type="checkbox" data-share="${m.id}"> Share my number (?)</label>
        `;
        matchesList.appendChild(row);

        // Checkbox handler
        const checkbox = row.querySelector("input");
        checkbox.addEventListener("change", () => updateShare(m.id, checkbox.checked));
      });

      // Build interests list
      interestList.innerHTML = "";
      interests.forEach(m => {
        const row = document.createElement("div");
        row.className = "interest-row";
        row.textContent = m.id;
        interestList.appendChild(row);
      });
    }

    async function updateShare(otherId, share) {
      const i_am = pid < otherId ? "p1" : "p2";

      await supabase.rpc("set_number_share", {
        p1: pid < otherId ? pid : otherId,
        p2: pid < otherId ? otherId : pid,
        i_am,
        i_share: share,
        admin_secret: "12345"
      });

      loadMatchList();
    }

    // Run everything
    loadNumbers().then(loadExistingSelections).then(loadMatchList);

  </script>
</body>
</html>
