<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Your Numbers</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; margin: 0; }
    .number-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px; max-width: 600px; margin: auto; }
    .number-cell { aspect-ratio: 1 / 1; background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px;
                   display: flex; align-items: center; justify-content: center; font-size: 1.2em;
                   cursor: pointer; user-select: none; transition: background-color 0.3s; }
    .number-cell.selected { background-color: #4caf50; color: white; border-color: #388e3c; }
    #summary { margin-top: 1.5em; text-align: center; font-size: 1em; }
    #confirmBtn, #clearBtn { margin-top: 1em; padding: 0.8em 1.6em; font-size: 1em; cursor: pointer; margin-right: 1em; }
    #priorityList { text-align: left; margin-top: 1em; font-family: monospace; white-space: pre-line; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2 id="welcome"></h2>
  <div class="number-grid" id="numbers"></div>

  <div id="summary">
    <p><strong>Your Selections:</strong></p>
    <div id="priorityList">None</div>

    <!-- NEW: Matches section (immediately under summary) -->
    <div id="matchesBlock" style="margin-top:1em; text-align:left; display:none;">
      <p><strong>Matches:</strong></p>
      <div id="matchesList"></div>
    </div>

    <!-- NEW: Incoming interest section -->
    <div id="interestBlock" style="margin-top:1em; text-align:left; display:none;">
      <p><strong>People interested in you:</strong></p>
      <div id="interestList"></div>
    </div>

    <button id="confirmBtn" disabled>Confirm Selection</button>
    <button id="clearBtn">Clear All</button>
  </div>

  <script>
    const SUPABASE_URL = "https://cfuwtozobaypksesmxsi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmdXd0b3pvYmF5cGtzZXNteHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNDc1NjksImV4cCI6MjA3NjcyMzU2OX0.SbpESIaS7JZJmWHQ6ApifGDPYZZf3ekdQ0T_mgHCPSc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const pid   = sessionStorage.getItem("pid");
    const pw    = sessionStorage.getItem("pw");
    const pname = sessionStorage.getItem("pname") || "Participant";

    if (!pid || !pw) {
      alert("Please log in first.");
      window.location.replace("participant.html");
    }

    document.getElementById("welcome").textContent = `Welcome ${pid} - ${pname}`;

    // Re-verify session via RPC
    async function verifySession() {
      const { data, error } = await supabase.rpc("verify_participant_login", {
        p_participant_id: pid,
        p_password: pw
      });
      if (error || !data || !data.length) {
        alert("Session expired or invalid. Please log in again.");
        sessionStorage.clear();
        window.location.replace("participant.html");
      }
    }
    verifySession();

    const numbersDiv      = document.getElementById("numbers");
    const priorityListDiv = document.getElementById("priorityList");
    const confirmBtn      = document.getElementById("confirmBtn");
    const clearBtn        = document.getElementById("clearBtn");

    const matchesBlock    = document.getElementById("matchesBlock");
    const matchesList     = document.getElementById("matchesList");
    const interestBlock   = document.getElementById("interestBlock");
    const interestList    = document.getElementById("interestList");

    let selectedList = [];
    let existingSelections = [];

    // --- Load dynamic grid based on opposite IDs (using your get_opposite_ids RPC) ---
    async function loadNumbers() {
      try {
        const { data, error } = await supabase.rpc("get_opposite_ids", {
          p_participant_id: pid
        });
        if (error) {
          console.error("get_opposite_ids error:", error.message);
          return;
        }

        numbersDiv.innerHTML = "";
        selectedList = [];

        (data || []).forEach(row => {
          const fullId = row; // e.g. "M2" or "F5"
          const numPart = fullId.substring(1); // just the number for display
          const cell = document.createElement("div");
          cell.className = "number-cell";
          cell.textContent = numPart;
          cell.dataset.pid = fullId;
          cell.addEventListener("click", () => toggleSelection(fullId, cell));
          numbersDiv.appendChild(cell);
        });
      } catch (err) {
        console.error("loadNumbers error:", err);
      }
    }

    function toggleSelection(id, cell) {
      const idx = selectedList.indexOf(id);
      if (idx >= 0) {
        selectedList.splice(idx, 1);
        cell.classList.remove("selected");
      } else {
        selectedList.push(id);
        cell.classList.add("selected");
      }
      updateSummary();
      // We DON'T immediately update matches here, because matches are based on saved selections.
      // They will reflect the last confirmed save.
    }

    function updateSummary() {
      if (!selectedList.length) {
        priorityListDiv.textContent = "None";
        confirmBtn.disabled = false;
        return;
      }
      priorityListDiv.textContent = "You selected: " + selectedList.join(", ");
      confirmBtn.disabled = false;
    }

    async function loadExistingSelections() {
      try {
        const { data, error } = await supabase
          .from("participants")
          .select("selections")
          .eq("participant_id", pid)
          .maybeSingle();

        if (error) {
          console.error("loadExistingSelections error:", error.message);
          return;
        }

        if (data && data.selections) {
          existingSelections = data.selections;
          existingSelections.forEach(selId => {
            const cell = document.querySelector(`.number-cell[data-pid="${selId}"]`);
            if (cell) {
              cell.classList.add("selected");
              if (!selectedList.includes(selId)) {
                selectedList.push(selId);
              }
            }
          });
          updateSummary();
        }
      } catch (err) {
        console.error("loadExistingSelections error:", err);
      }
    }

    async function saveSelections() {
      const newSelections = [...selectedList];

      try {
        const { data: existing, error: exError } = await supabase
          .from("participants")
          .select("id")
          .eq("participant_id", pid)
          .maybeSingle();

        if (exError) {
          console.error("check existing error:", exError.message);
        }

        if (existing) {
          const { error: updError } = await supabase
            .from("participants")
            .update({ selections: newSelections })
            .eq("participant_id", pid);
          if (updError) throw updError;
        } else {
          const { error: insError } = await supabase
            .from("participants")
            .insert([{ participant_id: pid, name: pname, selections: newSelections }]);
          if (insError) throw insError;
        }

        alert(`✅ Thank you, ${pname}! Your selections are saved.`);
        sessionStorage.clear();
        window.location.replace("scanqr.html");
      } catch (err) {
        console.error("saveSelections error:", err);
        alert("⚠️ Failed to save data.");
      }
    }

    confirmBtn.addEventListener("click", saveSelections);

    clearBtn.addEventListener("click", () => {
      selectedList = [];
      document.querySelectorAll(".number-cell.selected").forEach(c => c.classList.remove("selected"));
      updateSummary();
      // Matches and interests will remain based on last saved state
    });

    // --- NEW: Load matches + interests via secure RPC ---
    async function loadMatchesAndInterests() {
      try {
        // This RPC should be the participant-safe one you created:
        // get_matches_and_interests_secure(p_pid text)
        const { data, error } = await supabase.rpc("get_matches_and_interests_secure", {
          p_pid: pid
        });
        if (error) {
          console.error("get_matches_and_interests_secure error:", error.message);
          matchesBlock.style.display = "none";
          interestBlock.style.display = "none";
          return;
        }

        const rows = data || [];
        const matches   = rows.filter(r => r.match_id);
        const interests = rows.filter(r => r.interest_id);

        // Matches
        matchesList.innerHTML = "";
        if (matches.length) {
          matchesBlock.style.display = "block";
          matches.forEach(m => {
            const otherId = m.match_id;
            const row = document.createElement("div");
            row.style.marginBottom = "6px";
            row.innerHTML = `
              • ${otherId} — <span>Number will be revealed when both parties agree.</span><br>
              <label>
                <input type="checkbox" data-other="${otherId}">
                Share my number (?)
              </label>
            `;
            matchesList.appendChild(row);

            const checkbox = row.querySelector("input[type='checkbox']");
            checkbox.addEventListener("change", () => {
              updateSharePreference(otherId, checkbox.checked);
            });
          });
        } else {
          matchesBlock.style.display = "none";
        }

        // Incoming interest
        interestList.innerHTML = "";
        if (interests.length) {
          interestBlock.style.display = "block";
          interests.forEach(i => {
            const otherId = i.interest_id;
            const row = document.createElement("div");
            row.style.marginBottom = "4px";
            row.textContent = otherId;
            interestList.appendChild(row);
          });
        } else {
          interestBlock.style.display = "none";
        }

      } catch (err) {
        console.error("loadMatchesAndInterests error:", err);
        matchesBlock.style.display = "none";
        interestBlock.style.display = "none";
      }
    }

    // --- NEW: Update number share preference ---
    async function updateSharePreference(otherId, agree) {
      try {
        const { error } = await supabase.rpc("update_number_share", {
          p_pid: pid,
          p_other: otherId,
          p_agree: agree
        });
        if (error) {
          console.error("update_number_share error:", error.message);
        }
        // In future we can re-load to check if both agreed and then reveal numbers.
        // For now, we only persist the choice.
      } catch (err) {
        console.error("updateSharePreference error:", err);
      }
    }

    // Initial load
    (async function init() {
      await loadNumbers();
      await loadExistingSelections();
      await loadMatchesAndInterests();  // uses last saved selections
    })();
  </script>
</body>
</html>
