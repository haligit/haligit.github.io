<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Your Numbers</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; margin: 0; }
    .number-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px; max-width: 600px; margin: auto; }
    .number-cell { aspect-ratio: 1 / 1; background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px;
                   display: flex; align-items: center; justify-content: center; font-size: 1.2em;
                   cursor: pointer; user-select: none; transition: background-color 0.3s; }
    .number-cell.selected { background-color: #4caf50; color: white; border-color: #388e3c; }
    #summary { margin-top: 1.5em; text-align: center; font-size: 1em; }
    #confirmBtn, #clearBtn { margin-top: 1em; padding: 0.8em 1.6em; font-size: 1em; cursor: pointer; margin-right: 1em; }
    #priorityList { text-align: left; margin-top: 1em; font-family: monospace; white-space: pre-line; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2 id="welcome"></h2>
  <div class="number-grid" id="numbers"></div>

  <div id="summary">
    <p><strong>Your Selections:</strong></p>
    <div id="priorityList">None</div>

    <!-- Matches -->
    <div id="matchesBlock" style="margin-top:1em; text-align:left; display:none;">
      <p><strong>Matches:</strong></p>
      <div id="matchesList"></div>
    </div>

    <!-- Incoming interest -->
    <div id="interestBlock" style="margin-top:1em; text-align:left; display:none;">
      <p><strong>People interested in you:</strong></p>
      <div id="interestList"></div>
    </div>

    <button id="confirmBtn" disabled>Confirm Selection</button>
    <button id="clearBtn">Clear All</button>
  </div>

<script>
/* -----------------------------
   Supabase Setup
--------------------------------*/
const SUPABASE_URL = "https://cfuwtozobaypksesmxsi.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmdXd0b3pvYmF5cGtzZXNteHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNDc1NjksImV4cCI6MjA3NjcyMzU2OX0.SbpESIaS7JZJmWHQ6ApifGDPYZZf3ekdQ0T_mgHCPSc";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const pid   = sessionStorage.getItem("pid");
const pw    = sessionStorage.getItem("pw");
const pname = sessionStorage.getItem("pname") || "Participant";

if (!pid || !pw) {
  alert("Please log in first.");
  window.location.replace("participant.html");
}

document.getElementById("welcome").textContent = `Welcome ${pid} - ${pname}`;

/* -----------------------------
   Verify session still valid
--------------------------------*/
async function verifySession() {
  const { data, error } = await supabase.rpc("verify_participant_login", {
    p_participant_id: pid,
    p_password: pw
  });
  if (error || !data || !data.length) {
    alert("Session expired or invalid.");
    sessionStorage.clear();
    window.location.replace("participant.html");
  }
}
verifySession();

/* -----------------------------
   DOM refs
--------------------------------*/
const numbersDiv   = document.getElementById("numbers");
const priorityList = document.getElementById("priorityList");
const confirmBtn   = document.getElementById("confirmBtn");
const clearBtn     = document.getElementById("clearBtn");

const matchesBlock = document.getElementById("matchesBlock");
const matchesList  = document.getElementById("matchesList");
const interestBlock= document.getElementById("interestBlock");
const interestList = document.getElementById("interestList");

let selectedList = [];
let existingSelections = [];

/* -----------------------------
   Load Numbers (based on gender)
--------------------------------*/
async function loadNumbers() {
  const { data, error } = await supabase.rpc("get_opposite_ids", { p_pid: pid });

  numbersDiv.innerHTML = "";
  selectedList.length = 0;

  (data || []).forEach(row => {
    const fullId = row.id;
    const cell = document.createElement("div");
    cell.classList.add("number-cell");
    cell.dataset.pid = fullId;
    cell.textContent = fullId;

    cell.addEventListener("click", () => toggleSelection(fullId, cell));

    numbersDiv.appendChild(cell);
  });
}

/* -----------------------------
   Selection Toggle
--------------------------------*/
function toggleSelection(id, cell) {
  const i = selectedList.indexOf(id);
  if (i >= 0) {
    selectedList.splice(i, 1);
    cell.classList.remove("selected");
  } else {
    selectedList.push(id);
    cell.classList.add("selected");
  }
  updateSummary();
}

/* -----------------------------
   Update Summary
--------------------------------*/
function updateSummary() {
  if (!selectedList.length) {
    priorityList.textContent = "None";
    confirmBtn.disabled = false;
    return;
  }
  priorityList.textContent = "You selected: " + selectedList.join(", ");
  confirmBtn.disabled = false;
}

/* -----------------------------
   Load existing saved selections
--------------------------------*/
async function loadExistingSelections() {
  const { data } = await supabase
    .from("participants")
    .select("selections")
    .eq("participant_id", pid)
    .maybeSingle();

  if (data && data.selections) {
    existingSelections = data.selections;
    existingSelections.forEach(id => {
      const cell = document.querySelector(`.number-cell[data-pid="${id}"]`);
      if (cell) {
        cell.classList.add("selected");
        selectedList.push(id);
      }
    });
    updateSummary();
  }
}

/* -----------------------------
   Save selections
--------------------------------*/
async function saveSelections() {
  const newSelections = [...selectedList];
// 1. Load old selections from DB
const oldSel = existingSelections || [];

// 2. Identify which matches were removed
const removed = oldSel.filter(x => !newSelections.includes(x));

// 3. For each removed match â†’ delete number_share row
for (const otherId of removed) {
  // Order alphabetically to match DB rule
  const id1 = pid < otherId ? pid : otherId;
  const id2 = pid < otherId ? otherId : pid;

  await supabase
    .from("number_share")
    .delete()
    .match({ p1_id: id1, p2_id: id2 });
}

  const { data: existing } = await supabase
    .from("participants")
    .select("id")
    .eq("participant_id", pid)
    .maybeSingle();

  if (existing) {
    await supabase.from("participants")
      .update({ selections: newSelections })
      .eq("participant_id", pid);
  } else {
    await supabase.from("participants")
      .insert([{ participant_id: pid, name: pname, selections: newSelections }]);
  }

  alert(`âœ… Thanks ${pname}! Your selections are saved.`);

  // Reload matches instantly
  await loadMatchesAndInterests();

//  setTimeout(() => {
    sessionStorage.clear();
    window.location.replace("participant.html");
//    window.location.replace("scanqr.html");
//  }, 600);
}

confirmBtn.addEventListener("click", saveSelections);

/* -----------------------------
   Clear selection
--------------------------------*/
clearBtn.addEventListener("click", () => {
  selectedList = [];
  document.querySelectorAll(".number-cell.selected").forEach(c => c.classList.remove("selected"));
  updateSummary();
});

/* -----------------------------
   Load Matches & Interests
--------------------------------*/
async function loadMatchesAndInterests() {
  const { data, error } = await supabase.rpc("get_matches_and_interests_secure", {
    p_pid: pid
  });

  if (error) {
    console.error("get_matches_and_interests_secure error:", error.message);
    return;
  }

  const rows = data || [];

  const matches   = rows.filter(r => r.match_id);
  const matchIds  = matches.map(m => m.match_id);

  const interests = rows
    .filter(r => r.interest_id)
    .filter(r => !matchIds.includes(r.interest_id));

  /* ------- MATCHES ------- */
  matchesList.innerHTML = "";
  if (matches.length) {
    matchesBlock.style.display = "block";
    matches.forEach(m => {
      renderMatchRow(
        m.match_id,
        m.my_agree,
        m.other_agree,
        m.reveal_number
      );
    });
  } else {
    matchesBlock.style.display = "none";
  }

  /* ------- INTERESTS ------- */
  interestList.innerHTML = "";
  if (interests.length) {
    interestBlock.style.display = "block";
    interests.forEach(i => {
      const div = document.createElement("div");
      div.textContent = i.interest_id;
      div.style.marginBottom = "4px";
      interestList.appendChild(div);
    });
  } else {
    interestBlock.style.display = "none";
  }
}

/* -----------------------------
   Render a MATCH row
--------------------------------*/
function renderMatchRow(otherId, myAgree, otherAgree, revealNumber) {
  const row = document.createElement("div");
  row.style.marginBottom = "12px";

  const bothAgree = myAgree && otherAgree;

  row.innerHTML = `
    â€¢ ${otherId} â€”
      ${bothAgree && revealNumber
        ? `<strong>ðŸ“ž ${revealNumber}</strong>`
        : `<span>Number will be revealed when both parties agree.</span>`
      }
      <br>

    <label>
      <input type="checkbox" data-other="${otherId}">
      Share my number (?)
    </label>

    <br>
    <button class="revealBtn" data-other="${otherId}" style="margin-top:4px;">
      ${bothAgree && revealNumber ? "Number Revealed" : "Tap to Reveal"}
    </button>
  `;

  matchesList.appendChild(row);

  /* ----- Checkbox: reflect my saved state ----- */
  const checkbox = row.querySelector("input[type='checkbox']");
  checkbox.checked = myAgree;

  checkbox.addEventListener("change", async () => {
    await updateSharePreference(otherId, checkbox.checked);
    await loadMatchesAndInterests();  // reload UI
  });

  /* ----- Reveal button ----- */
  const revealBtn = row.querySelector(".revealBtn");
  revealBtn.addEventListener("click", () => {
    attemptReveal(otherId, revealBtn, checkbox);
  });
}


/* -----------------------------
   Try to Reveal Number
--------------------------------*/
async function attemptReveal(otherId, btn, checkbox) {
  btn.textContent = "Checkingâ€¦";

  const { data, error } = await supabase.rpc("get_matches_and_interests_secure", {
    p_pid: pid
  });

  if (error || !data) {
    btn.textContent = "Error, try again";
    return;
  }

  const match = data.find(r => r.match_id === otherId);

  if (!match) {
    btn.textContent = "No longer a match";
    return;
  }

  if (match.reveal_number) {
    btn.innerHTML = `ðŸ“ž ${match.reveal_number}`;
    return;
  }

  btn.textContent = `Waiting for ${otherId}â€¦`;
  setTimeout(() => {
    btn.textContent = "Tap to Reveal";
  }, 1500);
}

/* -----------------------------
   Update number share
--------------------------------*/
async function updateSharePreference(otherId, agree) {
  await supabase.rpc("update_number_share", {
    p_pid: pid,
    p_other: otherId,
    p_agree: agree
  });
}

/* -----------------------------
   INIT
--------------------------------*/
(async function init() {
  await loadNumbers();
  await loadExistingSelections();

  setTimeout(async () => {
    await loadMatchesAndInterests();
  }, 150);
})();
</script>
</body>
</html>
