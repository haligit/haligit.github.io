<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Select Your Numbers</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1em; margin: 0; }
    .number-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px; max-width: 600px; margin: auto; }
    .number-cell { aspect-ratio: 1 / 1; background: #f0f0f0; border: 1px solid #ccc; border-radius: 8px;
                   display: flex; align-items: center; justify-content: center; font-size: 1.2em;
                   cursor: pointer; user-select: none; transition: background-color 0.3s; }
    .number-cell.selected { background-color: #4caf50; color: white; border-color: #388e3c; }
    #summary { margin-top: 1.5em; text-align: center; font-size: 1em; }
    #confirmBtn, #clearBtn { margin-top: 1em; padding: 0.8em 1.6em; font-size: 1em; cursor: pointer; margin-right: 1em; }
    #priorityList { text-align: left; margin-top: 1em; font-family: monospace; white-space: pre-line; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2 id="welcome"></h2>
  <div class="number-grid" id="numbers"></div>

  <div id="summary">
    <p><strong>Your Selections:</strong></p>
    <div id="priorityList">None</div>

    <div id="matchesBlock" style="margin-top:1em; text-align:left; display:none;">
      <p><strong>Matches:</strong></p>
      <div id="matchesList"></div>
    </div>

    <div id="interestBlock" style="margin-top:1em; text-align:left; display:none;">
      <p><strong>People interested in you:</strong></p>
      <div id="interestList"></div>
    </div>

    <button id="confirmBtn" disabled>Confirm Selection</button>
    <button id="clearBtn">Clear All</button>
  </div>

  <script>
    const SUPABASE_URL = "https://cfuwtozobaypksesmxsi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmdXd0b3pvYmF5cGtzZXNteHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNDc1NjksImV4cCI6MjA3NjcyMzU2OX0.SbpESIaS7JZJmWHQ6ApifGDPYZZf3ekdQ0T_mgHCPSc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const pid   = sessionStorage.getItem("pid");
    const pw    = sessionStorage.getItem("pw");
    const pname = sessionStorage.getItem("pname") || "Participant";

    if (!pid || !pw) {
      alert("Please log in first.");
      window.location.replace("participant.html");
    }

    document.getElementById("welcome").textContent = `Welcome ${pid} - ${pname}`;

    async function verifySession() {
      const { data, error } = await supabase.rpc("verify_participant_login", {
        p_participant_id: pid,
        p_password: pw
      });
      if (error || !data || !data.length) {
        alert("Session expired or invalid. Please log in again.");
        sessionStorage.clear();
        window.location.replace("participant.html");
      }
    }
    verifySession();

    const numbersDiv      = document.getElementById("numbers");
    const priorityListDiv = document.getElementById("priorityList");
    const confirmBtn      = document.getElementById("confirmBtn");
    const clearBtn        = document.getElementById("clearBtn");
    const matchesBlock    = document.getElementById("matchesBlock");
    const matchesList     = document.getElementById("matchesList");
    const interestBlock   = document.getElementById("interestBlock");
    const interestList    = document.getElementById("interestList");

    let selectedList = [];
    let existingSelections = [];

    async function loadNumbers() {
      try {
        const { data, error } = await supabase.rpc("get_opposite_ids", { p_pid: pid });

        if (error) {
          console.error("get_opposite_ids RPC error:", error.message);
          return;
        }

        numbersDiv.innerHTML = "";
        selectedList.length = 0;

        (data || []).forEach(row => {
          const fullId = row.id;
          const cell = document.createElement("div");

          cell.classList.add("number-cell");
          cell.dataset.pid = fullId;
          cell.textContent = fullId;

          cell.addEventListener("click", () => toggleSelection(fullId, cell));

          numbersDiv.appendChild(cell);
        });

      } catch (err) {
        console.error("loadNumbers error:", err);
      }
    }

    function toggleSelection(id, cell) {
      const idx = selectedList.indexOf(id);
      if (idx >= 0) {
        selectedList.splice(idx, 1);
        cell.classList.remove("selected");
      } else {
        selectedList.push(id);
        cell.classList.add("selected");
      }
      updateSummary();
    }

    function updateSummary() {
      if (!selectedList.length) {
        priorityListDiv.textContent = "None";
        confirmBtn.disabled = false;
        return;
      }
      priorityListDiv.textContent = "You selected: " + selectedList.join(", ");
      confirmBtn.disabled = false;
    }

    async function loadExistingSelections() {
      try {
        const { data } = await supabase
          .from("participants")
          .select("selections")
          .eq("participant_id", pid)
          .maybeSingle();

        if (data && data.selections) {
          existingSelections = data.selections;

          existingSelections.forEach(selId => {
            const cell = document.querySelector(`.number-cell[data-pid="${selId}"]`);
            if (cell) {
              cell.classList.add("selected");
              if (!selectedList.includes(selId)) {
                selectedList.push(selId);
              }
            }
          });

          updateSummary();
        }
      } catch (err) {
        console.error("loadExistingSelections error:", err);
      }
    }

    async function saveSelections() {
      const newSelections = [...selectedList];

      try {
        const { data: existing } = await supabase
          .from("participants")
          .select("id")
          .eq("participant_id", pid)
          .maybeSingle();

        if (existing) {
          await supabase
            .from("participants")
            .update({ selections: newSelections })
            .eq("participant_id", pid);
        } else {
          await supabase
            .from("participants")
            .insert([{ participant_id: pid, name: pname, selections: newSelections }]);
        }

        alert(`âœ… Thank you, ${pname}! Your selections are saved.`);

        await loadMatchesAndInterests();

        setTimeout(() => {
          sessionStorage.clear();
          window.location.replace("scanqr.html");
        }, 800);

      } catch (err) {
        console.error("saveSelections error:", err);
        alert("âš ï¸ Failed to save data.");
      }
    }

    confirmBtn.addEventListener("click", saveSelections);

    clearBtn.addEventListener("click", () => {
      selectedList = [];
      document.querySelectorAll(".number-cell.selected").forEach(c => c.classList.remove("selected"));
      updateSummary();
    });

    async function loadMatchesAndInterests() {
      try {
        const { data, error } = await supabase.rpc("get_matches_and_interests_secure", {
          p_pid: pid
        });

        if (error) {
          console.error("get_matches_and_interests_secure error:", error.message);
          matchesBlock.style.display = "none";
          interestBlock.style.display = "none";
          return;
        }

        const rows = data || [];

        const matches = rows.filter(r => r.match_id);
        const matchIds = matches.map(m => m.match_id);

        let interests = rows
          .filter(r => r.interest_id)
          .filter(r => !matchIds.includes(r.interest_id));

        // Matches
        matchesList.innerHTML = "";
        if (matches.length) {
          matchesBlock.style.display = "block";

          matches.forEach(m => {
            const otherId      = m.match_id;
            const revealNumber = m.reveal_number;
            const myAgree      = m.my_agree;   // NEW

            const row = document.createElement("div");
            row.style.marginBottom = "10px";

            // Checkbox should be checked if:
            // - I already agreed, OR
            // - both agreed and number is revealed
            const checkedAttr = (revealNumber || myAgree) ? "checked" : "";

            if (revealNumber) {
              row.innerHTML = `
                â€¢ ${otherId} â€” <strong>ðŸ“ž ${revealNumber}</strong><br>
                <label>
                  <input type="checkbox" data-other="${otherId}" ${checkedAttr}>
                  Share my number (?)
                </label>
              `;
            } else {
              row.innerHTML = `
                â€¢ ${otherId} â€” <span>Number will be revealed when both parties agree.</span><br>
                <label>
                  <input type="checkbox" data-other="${otherId}" ${checkedAttr}>
                  Share my number (?)
                </label>
              `;
            }

            matchesList.appendChild(row);

            const checkbox = row.querySelector("input[type='checkbox']");
            checkbox.addEventListener("change", async () => {
              await updateSharePreference(otherId, checkbox.checked);
              await loadMatchesAndInterests();
            });
          });

        } else {
          matchesBlock.style.display = "none";
        }

        interestList.innerHTML = "";
        if (interests.length) {
          interestBlock.style.display = "block";
          interests.forEach(i => {
            const div = document.createElement("div");
            div.style.marginBottom = "4px";
            div.textContent = i.interest_id;
            interestList.appendChild(div);
          });
        } else {
          interestBlock.style.display = "none";
        }

      } catch (err) {
        console.error("loadMatchesAndInterests error:", err);
      }
    }

    async function updateSharePreference(otherId, agree) {
      try {
        await supabase.rpc("update_number_share", {
          p_pid: pid,
          p_other: otherId,
          p_agree: agree
        });
      } catch (err) {
        console.error("updateSharePreference error:", err);
      }
    }

    (async function init() {
      await loadNumbers();
      await loadExistingSelections();

      setTimeout(async () => {
        await loadMatchesAndInterests();
      }, 150);
    })();
  </script>
</body>
</html>
