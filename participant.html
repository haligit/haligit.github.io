<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Participant Login</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 2em;
    max-width: 420px;
    margin: auto;
    text-align: center;
  }
  label {
    display:block;
    text-align:left;
    margin-top:12px;
    margin-bottom:6px;
  }
  .pw-container {
    position: relative;
    display: block;
  }
  input[type="text"], input[type="password"] {
    width: 100%;
    padding: 10px 40px 10px 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-sizing: border-box;
  }
  /* üëÅ button always visible */
  #togglePw {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    line-height: 1;
    color: #555;
  }
  #togglePw:hover {
    color: #000;
  }
  button.primary {
    margin-top: 1em;
    width: 100%;
    background:#2f7d32;
    color:#fff;
    border:none;
    border-radius:6px;
    font-size:16px;
    padding:0.6em 1.2em;
    cursor:pointer;
  }
  #result { margin-top:1em;font-weight:bold;min-height:1.2em;}
  .err {color:#c62828;} .ok{color:#2e7d32;}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h2>Participant Login</h2>
  <p style="font-size:13px;color:#666;">Enter your participant ID and password (password given by admin).</p>

  <label for="pidInput">Participant ID (e.g., M12 / F5)</label>
  <input id="pidInput" type="text" placeholder="M12 or F5" autocomplete="off">

  <label for="pwInput">Password</label>
  <div class="pw-container">
    <input id="pwInput" type="password" placeholder="Enter password" autocomplete="off">
    <button id="togglePw" type="button" aria-label="Show password">üëÅ</button>
  </div>

  <button id="loginBtn" class="primary">Login</button>
  <div id="result" role="status"></div>

<script>
  const SUPABASE_URL = "https://cfuwtozobaypksesmxsi.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmdXd0b3pvYmF5cGtzZXNteHNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExNDc1NjksImV4cCI6MjA3NjcyMzU2OX0.SbpESIaS7JZJmWHQ6ApifGDPYZZf3ekdQ0T_mgHCPSc";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const pidInput = document.getElementById("pidInput");
  const pwInput = document.getElementById("pwInput");
  const togglePw = document.getElementById("togglePw");
  const loginBtn = document.getElementById("loginBtn");
  const resultDiv = document.getElementById("result");

  // normalize ID to uppercase
  pidInput.addEventListener("input", e => e.target.value = e.target.value.toUpperCase());

  // üëÅ toggle visibility using emoji
  let visible = false;
  togglePw.addEventListener("click", ()=>{
    visible = !visible;
    pwInput.type = visible ? "text" : "password";
    togglePw.textContent = visible ? "üôà" : "üëÅ";
  });

  function showMsg(msg, ok=false){
    resultDiv.innerHTML = ok ? `<span class="ok">${msg}</span>` : `<span class="err">${msg}</span>`;
  }

  async function loginParticipant(){
    const pid = pidInput.value.trim().toUpperCase();
    const pw = pwInput.value.trim();
    if(!pid || !pw){ showMsg("Please enter both ID and Password."); return; }

    try{
const { data, error } = await supabase.rpc('verify_participant_login', {
  p_participant_id: pid,
  p_password: pw
});

      if(error) throw error;
      if(!data){ showMsg("Invalid ID or Password."); return; }

      // ‚úÖ plain-text password match
      if((data.password_hash||"") === pw){
        showMsg("‚úÖ Login successful!", true);
        setTimeout(()=>{
          const url = `select.html?id=${encodeURIComponent(data.participant_id)}&name=${encodeURIComponent(data.name||"")}`;
          window.location.href = url;
        },600);
      } else {
        showMsg("Invalid ID or Password.");
      }
    } catch(err){ showMsg(err.message || "Error connecting to server."); console.error(err); }
  }

  loginBtn.addEventListener("click", loginParticipant);
  [pidInput,pwInput].forEach(el=>el.addEventListener("keydown",e=>{
    if(e.key==="Enter"){ e.preventDefault(); loginParticipant(); }
  }));
</script>
</body>
</html>
